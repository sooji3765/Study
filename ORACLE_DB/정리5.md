
# 09 : SQL문 속 또 다른 SQL문, 서브커리

### 09-1 : 서브쿼리

서브쿼리 : SQL 내부에서 사용하는 SELECT문

실습 9-3 : JONE 급여보다 높은 연봉을 받는 사원 정보 출력
~~~sql
SELECT *
FROM EMP
WHERE SAL > (SELECT SAL
    FROM EMP
    WHERE ENAME ='JONES');
~~~

복습
~~~sql
SELECT *
FROM EMP
WHERE COMM > (SELECT COMM
FROM EMP
WHERE ENAME ='ALLEN');    
~~~


### 09-2 : 실행결과가 하나인 단일행 서브쿼리

실행 결과가 단 하나의 행으로 나오는 서브쿼리

> 단일행 서브쿼리와 날짜형 데이터

실습 9-4
~~~sql
SELECT *
FROM EMP
WHERE HIREDATE < (SELECT HIREDATE
FROM EMP
WHERE ENAME ='SCOTT');
~~~

> 단일행 서브쿼리와 함수

실습 9-5
~~~sql
SELECT E.EMPNO, DEPTNO, D.DNAME, E.SAL
FROM EMP E NATURAL JOIN DEPT D
WHERE DEPTNO = 20
AND E.SAL >(SELECT AVG(SAL) FROM EMP);
~~~

복습
~~~sql
SELECT E.EMPNO, DEPTNO, D.DNAME, E.SAL
FROM EMP E NATURAL JOIN DEPT D
WHERE DEPTNO = 20
AND E.SAL <=(SELECT AVG(SAL) FROM EMP);
~~~

### 09-3 : 실행결과가 여러개인 다중행 서브쿼리

> IN 연산자

실습 9-6
~~~sql
SELECT *
FROM EMP
WHERE DEPTNO IN (20,10);
~~~

실습 9-7
~~~sql
SELECT *
FROM EMP
WHERE SAL IN (SELECT MAX(SAL) FROM EMP GROUP BY DEPTNO);
~~~

> ANY, SOME 연산자

조건에 맞는 열 출력 

실습 9-9: `ANY`
~~~sql
SELECT *
FROM EMP
WHERE SAL = ANY (SELECT MAX(SAL) FROM EMP GROUP BY DEPTNO);
~~~

실습 9-10: `SOME`
~~~sql
SELECT *
FROM EMP
WHERE SAL = SOME (SELECT MAX(SAL) FROM EMP GROUP BY DEPTNO);
~~~

실습 9-11
~~~sql
SELECT *
FROM EMP
WHERE SAL < ANY (SELECT SAL FROM EMP WHERE DEPTNO=30)
ORDER BY EMPNO;
~~~

> ALL 연산자

실습 9-15
~~~sql
SELECT *
FROM EMP
WHERE SAL < ALL (SELECT SAL FROM EMP WHERE DEPTNO=30)
ORDER BY EMPNO;
~~~

> EXISTS 연산자

실습 9-16
~~~sql
SELECT *
FROM EMP
WHERE EXISTS(SELECT DNAME
FROM DEPT WHERE DEPTNO =10);
~~~

복습
~~~sql
SELECT *
FROM EMP
WHERE HIREDATE < ALL(SELECT HIREDATE
FROM EMP
WHERE DEPTNO = 10);
~~~

### 09-4 : 실행결과가 여러개인 다중열 서브쿼리

비교할 데이터를 여러개 지정

실습 9-18
~~~sql
SELECT *
FROM EMP
WHERE (DEPTNO,SAL) IN (SELECT DEPTNO, MAX(SAL)
    FROM EMP
    GROUP BY DEPTNO
);
~~~

### 09-5 : FROM 절에 사용하는 서브쿼리와 WITH절

인라인 뷰 : SELECT 문을 통해 일부 데이터를 추출함

~~~sql
SELECT E10.EMPNO, E10.ENAME, E10.DEPTNO, D.DNAME
FROM (SELECT * FROM EMP WHERE DEPTNO =10) E10,
    (SELECT * FROM DEPT) D
WHERE E10.DEPTNO = D.DEPTNO;
~~~

실습 9-20 : WITH절 사용하기
~~~sql
WITH
E10 AS(SELECT * FROM EMP WHERE DEPTNO =10),
D AS (SELECT * FROM DEPT)
SELECT E10.EMPNO, E10.ENAME, E10.DEPTNO, D.DNAME
FROM E10, D
WHERE E10.DEPTNO = D.DEPTNO;
~~~

### 09-6 : SELECT절에 사용하는 서브쿼리

실습 9-21 : 스칼라 서브쿼리

~~~sql
SELECT EMPNO,ENAME,JOB, SAL,
    (SELECT GRADE
    FROM SALGRADE
    WHERE E.SAL BETWEEN LOSAL AND HISAL) AS SALGRADE,
    DEPTNO,
    (SELECT DNAME FROM DEPT WHERE E.DEPTNO = DEPT.DEPTNO) AS DNAME
FROM EMP E;
~~~


## 문제

> Q1

~~~sql
SELECT E.JOB,E.EMPNO, E.ENAME, E.SAL, DEPTNO, D.DNAME
FROM EMP E NATURAL JOIN DEPT D
WHERE E.JOB IN (SELECT JOB FROM EMP WHERE ENAME='ALLEN');
~~~

> Q2

~~~sql
SELECT E.EMPNO, E.ENAME,
D.DNAME,
E.HIREDATE, 
D.LOC, 
E.SAL, 
(SELECT S.GRADE FROM SALGRADE S WHERE E.SAL BETWEEN S.LOSAL AND S.HISAL) AS GRADE
FROM EMP E NATURAL JOIN DEPT D
WHERE E.SAL > (SELECT AVG(SAL) FROM EMP )
ORDER BY E.SAL DESC, E.EMPNO;
~~~

> Q3

~~~sql
SELECT E.EMPNO, E.ENAME, E.JOB, DEPTNO, D.DNAME, D.LOC
FROM EMP E NATURAL JOIN DEPT D
WHERE DEPTNO =10
AND E.JOB NOT IN(SELECT JOB FROM EMP WHERE DEPTNO=30);
~~~

> Q4

~~~sql
SELECT EMPNO,ENAME,SAL,(SELECT S.GRADE FROM SALGRADE S WHERE SAL BETWEEN S.LOSAL AND S.HISAL) AS GRADE
FROM EMP
WHERE SAL > (SELECT MAX(SAL) FROM EMP WHERE JOB='SALESMAN');
~~~