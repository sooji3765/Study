# 다중행 함수와 데이터 그룹화

## 07-1 : 하나의 열에 출력 결과를 담는 다중행 함수

- 다중행 함수: 그룹 함수 또는 복수행 함수로 불림

> 합계를 구하는 SUM 함수

실습 7-1
~~~sql
SELECT SUM(SAL)
FROM EMP;
~~~

실습 7-3 :추가 수당 합계
~~~sql
SELECT SUM(COMM)
FROM EMP;
~~~

- DISTINCT, ALL 함께

실습7-4
~~~sql
SELECT SUM(DISTINCT SAL),
    SUM(ALL SAL),
    SUM(SAL)
FROM EMP;
~~~

복습

~~~sql
SELECT SUM(SAL), SUM(COMM)
FROM EMP;
~~~

> 데이터 개수를 구해주는 COUNT 함수

실습 7-5 : 전체 사원 수
~~~sql
SELECT COUNT(*)
FROM EMP;
~~~

실습 7-6 : 부서 번호 30인 사원 수

~~~sql
SELECT COUNT(*)
FROM EMP
WHERE DEPTNO =30;
~~~

- DISTINCT, ALL 사용

실습 7-7

~~~sql
SELECT COUNT(DISTINCT SAL),
    COUNT(ALL SAL),
    COUNT(SAL)
FROM EMP;
~~~

- NULL 데이터는 반환 개수에서 제외

실습 7-8
~~~sql
SELECT COUNT(COMM)
FROM EMP;
~~~

실습 7-9
~~~sql
SELECT COUNT(COMM)
FROM EMP
WHERE COMM IS NOT NULL;
~~~

> 최대, 최소값 MAX,MIN 함수

실습 7-10 : 부서 10에서 높은 연봉

~~~sql
SELECT MAX(SAL)
FROM EMP
WHERE DEPTNO=10;
~~~

실습 7-11 : 부서 10에서 낮은 연봉
~~~sql
SELECT MIN(SAL)
FROM EMP
WHERE DEPTNO=10;
~~~

- 날짜 데이터에서 MAX, MIN

실습 7-12 : 부서 20에서 가장 최근 입사

~~~sql
SELECT MAX(HIREDATE)
FROM EMP
WHERE DEPTNO=20;
~~~

실습 7-13 : 부서 20에서 가장 오래된 입사

~~~sql
SELECT MIN(HIREDATE)
FROM EMP
WHERE DEPTNO=20;
~~~

> 평균값 구하는 AVG 함수

실습 7-14 : 부서 번호 30인 사원 평균 연봉

~~~sql
SELECT ROUND(AVG(SAL),2)
FROM EMP
WHERE DEPTNO =30;
~~~

- DISTINCT 중복 제거

실습 7-15

~~~sql
SELECT ROUND(AVG(DISTINCT SAL),2)
FROM EMP
WHERE DEPTNO =30;
~~~

복습

~~~sql
SELECT AVG(COMM)
FROM EMP
WHERE DEPTNO=30;
~~~

## 07-2 : 결과 값을 원하는 열로 묶어 출력하는 GROUP BY 절

실습 7-16: 집합 연산자를 사용하여 각 부서 평균 급여 출력

~~~sql
SELECT AVG(SAL),'10' AS DEPTNO FROM EMP WHERE DEPTNO=10
UNION ALL
SELECT AVG(SAL),'20' AS DEPTNO FROM EMP WHERE DEPTNO=20
UNION ALL
SELECT AVG(SAL),'30' AS DEPTNO FROM EMP WHERE DEPTNO=30;
~~~

실습 7-17 : GROUP BY 사용

~~~sql
SELECT DEPTNO, AVG(SAL)
FROM EMP
GROUP BY DEPTNO;
~~~

실습 7-18 : 부서 번호 및 직책별 평균 급여 정리

~~~sql
SELECT DEPTNO, JOB, AVG(SAL)
FROM EMP
GROUP BY DEPTNO, JOB
ORDER BY DEPTNO;
~~~

복습 : 부서 별 평균 추가 수당

~~~sql
SELECT DEPTNO, AVG(COMM)
FROM EMP
GROUP BY DEPTNO;
~~~

유의할 점 : 다중행 함수를 사용하지 않은 일반 열은 group by 절에 명시하지 않으면 select 절에서 사용 불가

## 07-3 : GROUP BY절에 조건을 줄 때 사용하는 HAVING절

출력 그룹을 제한하는 조건식

실습 7-20

~~~sql
SELECT DEPTNO, JOB, AVG(SAL)
FROM EMP
GROUP BY DEPTNO, JOB
HAVING AVG(SAL) >=2000
ORDER BY DEPTNO, JOB;
~~~

> WHERE 절과 HAVING 절 차이

실습 7-23

~~~sql
SELECT DEPTNO, JOB, AVG(SAL)
FROM EMP
WHERE SAL<= 3000
GROUP BY DEPTNO, JOB
HAVING AVG(SAL) >=2000
ORDER BY DEPTNO, JOB;
~~~

복습 :부서별 직책 별 평균 급여가 500 이상인 사원들의 부서 번호, 등 출력

~~~sql
SELECT DEPTNO, JOB, AVG(SAL)
FROM EMP
GROUP BY DEPTNO, JOB
HAVING AVG(SAL)>=500;
~~~


## 07-4 : 그룹화와 관련된 여러 함수

실습 7-25

~~~sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL)
  FROM EMP
GROUP BY ROLLUP(DEPTNO, JOB);
~~~

실습 7-26

~~~sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL)
  FROM EMP
GROUP BY CUBE(DEPTNO, JOB)
ORDER BY DEPTNO, JOB;
~~~

실습 7-27

~~~sql
SELECT DEPTNO, JOB, COUNT(*)
  FROM EMP
GROUP BY DEPTNO, ROLLUP(JOB);
~~~

실습 7-28

~~~sql
SELECT DEPTNO, JOB, COUNT(*)
  FROM EMP
GROUP BY JOB, ROLLUP(DEPTNO);
~~~

실습 7-29

~~~sql
SELECT DEPTNO, JOB, COUNT(*)
FROM EMP
GROUP BY GROUPING SETS(DEPTNO, JOB)
ORDER BY DEPTNO, JOB;
~~~

실습 7-30

~~~sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL),
       GROUPING(DEPTNO),
       GROUPING(JOB)
FROM EMP
GROUP BY CUBE(DEPTNO, JOB)
ORDER BY DEPTNO, JOB;
~~~

실습 7-31
~~~sql
SELECT DECODE(GROUPING(DEPTNO), 1, 'ALL_DEPT', DEPTNO) AS DEPTNO,
       DECODE(GROUPING(JOB), 1, 'ALL_JOB', JOB) AS JOB,
       COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL)
FROM EMP
GROUP BY CUBE(DEPTNO, JOB)
ORDER BY DEPTNO, JOB;
~~~

실습 7-32
~~~sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL),
       GROUPING(DEPTNO),
       GROUPING(JOB),
       GROUPING_ID(DEPTNO,JOB)
FROM EMP
GROUP BY CUBE(DEPTNO, JOB)
ORDER BY DEPTNO, JOB;
~~~

> LISTAGG 함수 : 11g 부터 적용하는 함수

~~~sql
SELECT DEPTNO,
LISTAGG(ENAME,',')
WITHIN GROUP(ORDER BY SAL DESC) AS ENAMES
FROM EMP
GROUP BY DEPTNO;
~~~

> PIVOT, UNPIVOT 함수 : 행과 열 바꾸는 함수

실습 7-36

~~~sql
SELECT *
FROM(SELECT DEPTNO, JOB, SAL
    FROM EMP)
PIVOT(MAX(SAL)
FOR DEPTNO IN (10,20,30)
)
ORDER BY JOB;
~~~

실습 7-37

~~~sql
SELECT *
  FROM(SELECT JOB, DEPTNO, SAL
         FROM EMP)
PIVOT(MAX(SAL)
     FOR JOB IN ('CLERK' AS CLERK,
                 'SALESMAN' AS SALESMAN,
                 'PRESIDENT' AS PRESIDENT,
                 'MANAGER' AS MANAGER,
                 'ANALYST' AS ANALYST)
     )
ORDER BY DEPTNO;
~~~

실습 7-38

~~~sql
SELECT DEPTNO,
       MAX(DECODE(JOB, 'CLERK', SAL)) AS "CLERK",
       MAX(DECODE(JOB, 'SALESMAN', SAL)) AS "SALESMAN",
       MAX(DECODE(JOB, 'PRESIDENT', SAL)) AS "PRESIDENT",
       MAX(DECODE(JOB, 'MANAGER', SAL)) AS "MANAGER",
       MAX(DECODE(JOB, 'ANALYST', SAL)) AS "ANALYST"
  FROM EMP
GROUP BY DEPTNO
ORDER BY DEPTNO;
~~~

실습 7-39

~~~sql
SELECT *
  FROM(SELECT DEPTNO,
              MAX(DECODE(JOB, 'CLERK' , SAL)) AS "CLERK",
              MAX(DECODE(JOB, 'SALESMAN' , SAL)) AS "SALESMAN",
              MAX(DECODE(JOB, 'PRESIDENT', SAL)) AS "PRESIDENT",
              MAX(DECODE(JOB, 'MANAGER' , SAL)) AS "MANAGER",
              MAX(DECODE(JOB, 'ANALYST' , SAL)) AS "ANALYST"
         FROM EMP
       GROUP BY DEPTNO
       ORDER BY DEPTNO)
UNPIVOT(
   SAL FOR JOB IN (CLERK, SALESMAN, PRESIDENT, MANAGER,ANALYST))
ORDER BY DEPTNO, JOB;
~~~

## 문제

> Q1

~~~sql
SELECT DEPTNO, 
    TRUNC(AVG(SAL),0) AS AVG_SAL, 
    MAX(SAL) AS MAX_SAL,
    MIN(SAL) AS MIN_SAL,
    COUNT(*) AS CNT
FROM EMP
GROUP BY DEPTNO
ORDER BY DEPTNO DESC;
~~~

> Q2

~~~sql
SELECT JOB, COUNT(*)
FROM EMP
GROUP BY JOB
HAVING COUNT(*) >=3;
~~~

> Q3

~~~sql
SELECT TO_CHAR(HIREDATE,'YYYY') AS HIREDATE, DEPTNO, COUNT(*) AS CNT
FROM EMP
GROUP BY TO_CHAR(HIREDATE,'YYYY') ,DEPTNO;
~~~

> Q4

~~~sql
SELECT NVL2(COMM,'O','X') AS EXIST_COMM, COUNT(*) AS CNT
FROM EMP
GROUP BY NVL2(COMM,'O','X');
~~~

> Q5

~~~sql
SELECT DEPTNO, 
    TO_CHAR(HIREDATE,'YYYY') AS HIRE_YEAR,
    COUNT(*) AS CNT,
    MAX(SAL) AS MAX_SAL,
    SUM(SAL) AS SUM_SAL,
    AVG(SAL) AS AVG_SAL
FROM EMP
GROUP BY ROLLUP(DEPTNO, TO_CHAR(HIREDATE,'YYYY'));
~~~